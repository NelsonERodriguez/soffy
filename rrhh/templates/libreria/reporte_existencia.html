{% extends "layouts/base.html" %}

{% block title %} Reporte de Existencias {% endblock title %}

{% block stylesheets %} {% endblock stylesheets %}

{% block content %}

    <div class="container-fluid">
        <div class="row">
            <div class="offset-md-2 col-md-8">
                <div class="card">
                    <div class="card-header card-header-primary card-header-icon">
                        <div class="card-icon">
                            <i class="material-icons">local_library</i>
                        </div>
                        <h4 class="card-title">
                            Reporte de Existencias
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-outline-primary active">
                                        <input type="radio" name="optTipo" id="optLibreria" checked value="lib" onchange="fntGetProductos();"> Librería
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="radio" name="optTipo" id="optLimpieza" value="lim" onchange="fntGetProductos();"> Limpieza
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="radio" name="optTipo" id="optFarmacia" value="far" onchange="fntGetProductos();"> Farmacia
                                    </label>
                                </div>
                            </div>
                        </div>
                        <table class="table table-striped table-hover" id="tblProductos">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Unidad de Medida</th>
                                    <th>Producto</th>
                                    <th>Existencias</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascripts %}
    <script>
        const strUrlGetProductos = "{% url 'rrhh-libreria_reporte_existencia_listado' %}";
        let intCorrelativo = 1, objDataTable = null;

        const fntCreateDatatable = () => {
            objDataTable = $('#tblProductos').DataTable({
                "pagingType": "full_numbers",
                "lengthMenu": [
                    [10, 25, 50, -1],
                    [10, 25, 50, "Todos"]
                ],
                language: objLenguajeDataTable,
                dom: 'lBfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        text: 'Excel',
                        className: 'btn btn-default'
                    }
                ]
            });
        };

        const fntGetProductos = () => {
            const data = new FormData();
            data.append('csrfmiddlewaretoken', getCookie('csrftoken'));

            let strTipo = "";
            if( document.getElementById("optLimpieza").checked ){
                strTipo = "lim";
            }
            else if( document.getElementById("optLibreria").checked ){
                strTipo = "lib";
            }
            else if( document.getElementById("optFarmacia").checked ){
                strTipo = "far";
            }

            data.append('tipo', strTipo);

            open_loading();
            fetch(strUrlGetProductos, {
                method: 'POST',
                body: data,
            })
            .then(response => response.json())
            .then(data => {
                let strHtml = '';
                if(data.status){
                    //alert_nova.showNotification(`${data.msj}`, "add_alert", "success");

                    data.productos.forEach((value)=>{
                        let strCodigo = value.codigo === null ? "" : value.codigo;
                        let strUnidadMedida = value.unidad_medida === null ? "" : value.unidad_medida;
                        strHtml += `
                            <tr>
                                <td class="text-left">${strCodigo}</td>
                                <td class="text-left">${strUnidadMedida}</td>
                                <td class="text-left">${value.producto}</td>
                                <td class="text-left">${value.existencia}</td>
                            </tr>
                        `;
                    });

                    if( objDataTable !== null ) {
                        objDataTable.clear().destroy();
                    }

                    $("#tblProductos tbody").html(strHtml);

                    fntCreateDatatable();
                }
                else{
                    alert_nova.showNotification(`${data.msj}`, "warning", "danger");
                }
                close_loading();
            })
            .catch(error => {
                alert_nova.showNotification(`Ocurrió un error inesperado. Revise su conexión a internet o contacte a TI.`, "warning", "danger");
                console.error(error);
                close_loading();
            });
        };

        $(document).ready(function(){
            fntGetProductos();
        });
    </script>
{% endblock javascripts %}