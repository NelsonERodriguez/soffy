{% extends "layouts/base.html" %}

{% block title %} Carga Matriz TIGO {% endblock title %}

{% block stylesheets %}
    <style>
        .input-numerico {
            text-align: right;
        }
        .required:after {
            content:" *";
            color:red;
        }

        input[type="file"] {
            -webkit-appearance: listbox; }
    </style>
{% endblock stylesheets %}

{% block content %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header card-header-primary card-header-icon">
                        <div class="card-icon">
                            <i class="material-icons">call</i>
                        </div>
                        <h4 class="card-title">Carga Matriz TIGO</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="fileinput fileinput-new text-center" data-provides="fileinput" style="width: 100%;">
                                    <div class="row align-items-center">
                                        <div class="col-sm-6">
                                            <div class="fileinput-new text-danger"><b>De click al botón para buscar un archivo xlsx.</b></div>
                                            <div class="fileinput-preview fileinput-exists"></div>
                                        </div>
                                        <div class="col-sm-3">
                                            <div class="btn btn-rose btn-file">
                                                <div class="fileinput-new">Subir Archivo</div>
                                                <div class="fileinput-exists">Cambiar Archivo</div>
                                                <input type="file" id="filArchivo" name="filArchivo" accept=".xlsx" required="true"/>
                                            </div>
                                        </div>
                                        <div class="col-sm-3">
                                            <a href="#filArchivo" class="btn btn-danger fileinput-exists" data-dismiss="fileinput" onclick="fntLimpiar();">
                                                <i class="fa fa-times"></i> Quitar el Archivo
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 text-right">
                                <button type="button" id="btnCargarDatos" class="btn btn-outline-success" onclick="fntCargarDatos();" style="display: none;">
                                    <i class="fa fa-upload"></i> Cargar Datos
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <table class="table table-striped table-hover" id="tblMatriz">
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Empleado</th>
                                            <th>Teléfono</th>
                                            <th>Cobro</th>
                                            <th>Subsidio</th>
                                            <th>Pagar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12" id="divContenido">
                &nbsp;
            </div>
        </div>
        <div class="modal" tabindex="-1" id="mdlConfirmar">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar los datos</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <table class="table table-striped table-hover dataTable no-footer table-bordered">
                                    <thead class="text-primary">
                                        <tr>
                                            <th width="50%">
                                                Información Antigua
                                            </th>
                                            <th width="50%">
                                                Información Nueva
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="2" class="text-center">Nombres</td>
                                        </tr>
                                        <tr>
                                            <td id="tdNombresA"></td>
                                            <td id="tdNombresN"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center">Apellidos</td>
                                        </tr>
                                        <tr>
                                            <td id="tdApellidosA"></td>
                                            <td id="tdApellidosN"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center">DPI</td>
                                        </tr>
                                        <tr>
                                            <td id="tdDpiA"></td>
                                            <td id="tdDpiN"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center">Departamento (Extensión del DPI)</td>
                                        </tr>
                                        <tr>
                                            <td id="tdDepartamentoA"></td>
                                            <td id="tdDepartamentoN"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center">Municipio (Extensión del DPI)</td>
                                        </tr>
                                        <tr>
                                            <td id="tdMunicipioA"></td>
                                            <td id="tdMunicipioN"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center">Dirección</td>
                                        </tr>
                                        <tr>
                                            <td id="tdDireccionA"></td>
                                            <td id="tdDireccionN"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center">Estado Civil</td>
                                        </tr>
                                        <tr>
                                            <td id="tdEstadoA"></td>
                                            <td id="tdEstadoN"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="btnGuardar">Confirmar Datos</button>
                    </div>
                </div>
            </div>
          </div>
    </div>

{% endblock content %}

{% block javascripts %}
    <script src="/static/assets/js/plugins/jasny-bootstrap.min.js"></script>

    <script>
        const strUrlGetInfo = "{% url 'rrhh-confirmar_datos_get_info' %}",
            strUrlGuardar = "{% url 'rrhh-telefonos_matriz_descuentos_guardar' %}",
            strUrlProcesar = "{% url 'rrhh-telefonos_matriz_descuentos_procesar' %}",
            valCSRF = getCookie('csrftoken');
        let objTblMatriz = null;

        const fntProcesar = () => {
            let input = document.getElementById('filArchivo');

            let formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            formData.append('filArchivo', input.files[0]);

            open_loading();
            fetch(`${strUrlProcesar}`, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if(data.status){
                    alert_nova.showNotification(data.msj, "add_alert", "success");
                    //window.location.reload();

                    if( objTblMatriz ) objTblMatriz.destroy()

                    objTblMatriz = $("#tblMatriz").DataTable ({
                        "pagingType": "full_numbers",
                        "lengthMenu": [
                            [-1, 10, 25, 50],
                            ["Todos", 10, 25, 50]
                        ],
                        "data" : data.data,
                        "columns" : [
                            { "data" : "codigo" },
                            { "data" : "empleado" },
                            { "data" : "telefono" },
                            { "data" : "cobro" },
                            {
                                "data" : "subsidio",
                                "render": function(data, type, row) {
                                    let strCodigo = row.codigo.length == 0 ? 0 : row.codigo;
                                    let strTelefono = row.telefono;
                                    let sinCobro = parseFloat(row.cobro);
                                    let sinSubsidio = parseFloat(data);
                                    return `<input type="number" onchange="fntChangeSubsidio(this, ${strCodigo})" id="txtSubsidio_${strTelefono}"
                                            name="txtSubsidio_${strTelefono}" class="form-control"
                                            data-cobro="${sinCobro}" max="${sinCobro}"
                                            value="${sinSubsidio}" data-codigo="${strCodigo}">`;
                                }
                            },
                            {
                                "data" : "pagar",
                                "render": function(data, type, row) {
                                    let strTelefono = row.telefono;
                                    let sinPagar = parseFloat(data);
                                    let sinPagarFormat = numberGTFormat.format(sinPagar)
                                    return `<label id="lblTotalTelefono_${strTelefono}">${sinPagarFormat}</label>`;
                                }
                            },
                        ],
                        /*rowGroup: {
                            dataSrc: [ "empleado" ]
                        },*/
                        rowGroup: {
                            endRender: function ( rows, group ) {

                                let total = rows
                                    .data()
                                    .pluck("pagar")
                                    .reduce( function (a, b) {
                                        return a + b;
                                    }, 0);

                                let str_codigo = rows.data()[0].codigo.length == 0 ? 0 : rows.data()[0].codigo;

                                let total_format = numberGTFormat.format(total)
                                return $('<tr/>').append(`
                                    <td style="border-bottom: 2px solid black;" colspan="4">&nbsp;</td>
                                    <td style="border-bottom: 2px solid black;text-align: right;">Total a pagar:</td>
                                    <td style="border-bottom: 2px solid black;text-align: left;">
                                        <label id="lblTotal_${str_codigo}">${total_format}</label>
                                    </td>`);
                            },
                            dataSrc: function (data) {
                                return data.empleado;
                            }
                        },
                        responsive: false,
                        language: objLenguajeDataTable,
                        autoPrint: false
                    });

                    document.getElementById("btnCargarDatos").style.display = "inline";
                }
                else{
                    alert_nova.showNotification(data.msj, "warning", "danger");
                }
                close_loading();
            })
            .catch(error => {
                close_loading();
                alert_nova.showNotification('Ocurrió un error, contacte con IT', 'warning', 'danger');
                console.error(error)
            });
        };

        const fntCargarDatos = () => {
            let descuentos = new Array();

            objTblMatriz.rows().every(function (rowIdx, tableLoop, rowLoop) {
                let data = this.data();
                descuentos[rowIdx] = {};
                descuentos[rowIdx]["codigo"] = data.codigo;
                descuentos[rowIdx]["telefono"] = data.telefono;
                let sinSubsidio = document.getElementById(`txtSubsidio_${data.telefono}`).value;
                descuentos[rowIdx]["subsidio"] = sinSubsidio;
                descuentos[rowIdx]["cobro"] = data.cobro;
            });

            let input = document.getElementById('filArchivo');

            let formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            formData.append('filArchivo', input.files[0]);

            open_loading();
            fetch(`${strUrlGuardar}`, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json; charset=UTF-8',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                method: 'POST',
                body: JSON.stringify({ "descuentos": descuentos }),
            })
            .then(response => response.json())
            .then(data => {
                if(data.status){
                    alert_nova.showNotification(data.msj, "add_alert", "success");
                }
                else{
                    alert_nova.showNotification(data.msj, "warning", "danger");
                }
                close_loading();
                window.location.reload();
            })
            .catch(error => {
                close_loading();
                alert_nova.showNotification('Ocurrió un error, contacte con IT', 'warning', 'danger');
                console.error(error)
            });
        };

        const fntLimpiar = () => {
            if( objTblMatriz ) objTblMatriz.destroy();
            $("#tblMatriz > tbody").html("");
            objTblMatriz = $("#tblMatriz").DataTable({
                "pagingType": "full_numbers",
                "lengthMenu": [
                    [-1, 10, 25, 50],
                    ["Todos", 10, 25, 50]
                ],
                responsive: false,
                language: objLenguajeDataTable,
                autoPrint: false
            });
            document.getElementById("btnCargarDatos").style.display = "none";

        };

        const fntChangeSubsidio = (objInput, strCodigoEmp) => {
            let sinCobro = parseFloat(objInput.dataset.cobro);
            let sinSubsidio = parseFloat(objInput.value);

            let sinTotal = sinCobro - sinSubsidio;

            if( isNaN(sinTotal) ){
                sinTotal = sinCobro;
            }

            let sinTotalFormat = numberGTFormat.format(sinTotal);

            let arrSplit = objInput.id.split("_");
            document.getElementById(`lblTotalTelefono_${arrSplit[1]}`).innerText = sinTotalFormat;

            let sinTotalCodigo = 0;
            $(`input[data-codigo='${strCodigoEmp}']`).each(function(){
                let rowCobro = parseFloat(this.dataset.cobro);
                let rowSubsidio = parseFloat(this.value);
                let sinOperacion = (rowCobro - rowSubsidio);

                if( isNaN(sinOperacion) ){
                    sinTotalCodigo += rowCobro;
                }
                else{
                    sinTotalCodigo += (rowCobro - rowSubsidio);
                }
            });

            if( isNaN(sinTotalCodigo) ){
                sinTotalCodigo = 0;
            }

            let sinTotalCodigoFormat = numberGTFormat.format(sinTotalCodigo);

            document.getElementById(`lblTotal_${strCodigoEmp}`).innerText = sinTotalCodigoFormat;
        }

        document.getElementById('filArchivo').addEventListener("change", (e) => {
            if( document.getElementById('filArchivo').files.length > 0 ){
                fntProcesar();
            }
            else{
                fntLimpiar();
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            fntLimpiar();
        });
    </script>

{% endblock javascripts %}